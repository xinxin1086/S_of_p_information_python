# 后端项目接口文档总结

## 基础配置

**技术栈**: Python 3.11 + Flask 3.1.2 + SQLAlchemy 2.0.45
**Base URL**: `/api`
**认证方式**: JWT Bearer Token
**数据格式**: JSON
**数据库**: MySQL
**部署方式**: 服务器部署

## 项目架构概述

### 模块化设计
项目采用Flask蓝图(Blueprint)模块化设计，主要包含以下核心模块：

- **API_user**: 用户管理模块 `/api/user`
- **API_admin**: 管理员模块 `/api/admin`
- **API_forum**: 论坛模块 `/api/forum`
- **API_science**: 科普文章模块 `/api/science`
- **API_activities**: 活动模块 `/api/activities`
- **API_notice**: 公告模块 `/api/notice`
- **common**: 公共接口模块 `/api/common`

## 数据模型

### 基础模型 (components/models/base.py)

#### BaseUser
- **功能**: 用户基础模型，提供密码哈希和验证
- **特性**: 支持密码加密、验证、JSON序列化

### 用户管理模型 (components/models/user_models.py)

#### User
- **表名**: `user_info`
- **描述**: 普通用户模型，包含完整的用户信息和权限管理
- **主要字段**: id, account, username, password_hash, email, avatar_url, role, permission, status, created_at, updated_at

#### Admin
- **表名**: `admin_info`
- **描述**: 管理员模型，支持分级权限管理
- **权限级别**: SUPER_ADMIN, ADMIN, USER

#### DeletedUser
- **表名**: `deleted_user`
- **描述**: 已删除用户模型（软删除）

## 接口优化与整合

### 接口架构彻底优化 (2024-12-22更新)

#### 优化背景
为了实现架构的清晰性和一致性，彻底清理了 `common/routes.py` 中的业务接口，将所有业务功能集中到对应的专用模块中。

#### 专用公开接口 (推荐使用)
**用户模块**: `/api/public/user/*`
```
GET /api/public/user/info                           # 获取用户基础信息
POST /api/public/user/info/batch                    # 批量获取用户信息
GET /api/public/user/statistics                     # 获取用户统计信息
```

**科普模块**: `/api/public/science/*`
```
GET /api/public/science/articles                    # 获取科普文章列表
GET /api/public/science/articles/<id>               # 获取科普文章详情
GET /api/public/science/articles/statistics         # 获取科普文章统计
```

**活动模块**: `/api/public/activities/*`
```
GET /api/public/activities/activities               # 获取活动列表
GET /api/public/activities/activities/<id>          # 获取活动详情
GET /api/public/activities/activities/statistics    # 获取活动统计
```

**公告模块**: `/api/public/notice/*`
```
GET /api/public/notice/list                         # 获取公告列表
GET /api/public/notice/detail/<id>                  # 获取公告详情
GET /api/public/notice/statistics                   # 获取公告统计信息
GET /api/public/notice/types                        # 获取公告类型列表
```

**论坛模块**: `/api/public/forum/*`
```
GET /api/public/forum/posts                         # 获取论坛帖子列表
GET /api/public/forum/posts/<id>                    # 获取帖子详情
GET /api/public/forum/posts/<id>/floors             # 获取帖子楼层列表
GET /api/public/forum/categories                    # 获取分类统计
```

#### 业务管理接口 (集中到专用模块)
**用户模块**: `/api/user/*` (API_user 模块)
- 用户注册、登录、认证
- 用户信息管理、头像上传
- 管理员用户管理功能

**科普模块**: `/api/science/*` (API_science 模块)
- 科普文章的CRUD操作
- 科普文章点赞、浏览记录
- 科普文章管理

**活动模块**: `/api/activities/*` (API_activities 模块)
- 活动创建、管理
- 活动预约、讨论
- 活动统计分析

**公告模块**: `/api/notice/*` (API_notice 模块)
- 公告创建、编辑、发布
- 公告审核、管理
- 公告附件管理

**论坛模块**: `/api/forum/*` (API_forum 模块)
- 论坛帖子CRUD操作
- 楼层和回复管理
- 论坛统计和分析

#### common模块职责重新定义
**common模块**现在只保留真正的公共功能：
```
POST /api/common/upload/image                        # 图片上传
POST /api/common/delete/image                        # 图片删除
POST /api/common/upload/avatar                       # 头像上传
POST /api/common/user/update                         # 用户信息更新
GET  /api/common/user/info                           # 用户信息查询
POST /api/common/attachment                         # 附件上传
GET  /api/common/attachments                        # 附件列表
```


#### 参数映射
| 旧接口参数 | 新接口参数 | 说明 |
|-----------|-----------|------|
| `title` | `keyword` | 关键词搜索（支持标题和内容） |
| `author_account` | `author_account` | 作者筛选（保持一致） |
| `page`, `size` | `page`, `size` | 分页参数（保持一致） |

#### 架构清晰化
- **专用接口**: `/api/public/science/*` - 用于公开访问（无需认证）
- **交互接口**: `/api/common/science/*` - 用于用户操作（需要认证）
- **兼容接口**: `/api/common/science/*` - 保持向后兼容

### 科普文章模型 (components/models/science_models.py)

#### ScienceArticle
- **表名**: `science_articles`
- **描述**: 科普文章模型
- **状态**: draft(草稿), published(已发布), hidden(已隐藏), deleted(已删除)

#### ScienceArticleLike
- **表名**: `science_article_likes`
- **描述**: 科普文章点赞模型

#### ScienceArticleVisit
- **表名**: `science_article_visits`
- **描述**: 科普文章访问记录模型

### 论坛管理模型 (components/models/forum_models.py)

#### ForumPost
- **表名**: `forum_posts`
- **描述**: 论坛帖子模型
- **状态**: active(活跃), hidden(隐藏), deleted(删除)

#### ForumFloor
- **表名**: `forum_floors`
- **描述**: 论坛楼层模型

#### ForumReply
- **表名**: `forum_replies`
- **描述**: 论坛回复模型

#### ForumVisit
- **表名**: `forum_visits`
- **描述**: 论坛访问记录模型

#### ForumLike
- **表名**: `forum_likes`
- **描述**: 论坛点赞模型

### 活动管理模型 (components/models/activity_models.py)

#### Activity
- **表名**: `activities`
- **描述**: 活动模型
- **状态**: draft(草稿), published(已发布), cancelled(已取消), completed(已完成)

#### ActivityBooking
- **表名**: `activity_bookings`
- **描述**: 活动预约模型

#### ActivityRating
- **表名**: `activity_rating`
- **描述**: 活动评分模型

#### ActivityDiscuss
- **表名**: `activity_discuss`
- **描述**: 活动讨论模型

#### ActivityDiscussComment
- **表名**: `activity_discuss_comment`
- **描述**: 活动讨论留言模型

### 公告管理模型 (components/models/notice_models.py)

#### Notice
- **表名**: `notice`
- **描述**: 公告模型
- **状态**: draft(草稿), published(已发布), hidden(已隐藏), deleted(已删除)

#### NoticeAttachment
- **表名**: `notice_attachments`
- **描述**: 公告附件模型

### 通用功能模型 (components/models/other_models.py)

#### Attachment
- **表名**: `attachments`
- **描述**: 附件模型，支持文件类型和大小管理

## 接口详细说明

## 1. 用户模块 (/api/user)

### 1.1 用户认证 (API_user/auth)

#### 用户登录
- **接口**: `POST /api/user/auth/login`
- **描述**: 用户登录认证
- **请求体**: `{ "account": "string", "password": "string" }`
- **响应**: `{ "code": 200, "message": "登录成功", "data": { "token": "jwt_token", "user_info": {...} } }`

#### 用户注册
- **接口**: `POST /api/user/auth/register`
- **描述**: 用户注册
- **请求体**: `{ "account": "string", "username": "string", "password": "string", "email": "string" }`

#### Token验证
- **接口**: `POST /api/user/auth/verify`
- **描述**: 验证Token有效性
- **认证**: 需要

### 1.2 用户信息管理 (API_user/user)

#### 获取当前用户信息
- **接口**: `GET /api/user/user/info`
- **描述**: 获取当前登录用户的详细信息
- **认证**: 需要

#### 获取指定用户信息
- **接口**: `GET /api/user/user/info/<account>`
- **描述**: 获取指定用户的基础信息（不含敏感信息）
- **认证**: 需要

#### 更新用户信息
- **接口**: `POST /api/user/user/update`
- **描述**: 更新用户个人信息
- **认证**: 需要
- **请求体**: `{ "username": "string", "email": "string", ... }`

#### 用户注销
- **接口**: `POST /api/user/user/delete-account`
- **描述**: 用户注销账号
- **认证**: 需要

### 1.3 头像管理

#### 上传头像
- **接口**: `POST /api/user/user/avatar`
- **描述**: 上传用户头像
- **认证**: 需要
- **请求**: multipart/form-data

#### 删除头像
- **接口**: `DELETE /api/user/user/avatar`
- **描述**: 删除用户头像
- **认证**: 需要

### 1.4 管理员用户管理 (API_user/admin)

#### 获取用户列表
- **接口**: `GET /api/user/admin/users`
- **描述**: 获取用户列表（支持分页和筛选）
- **认证**: 管理员权限

#### 用户管理操作
- **接口**: `POST /api/user/admin/users`
- **描述**: 创建/更新用户信息
- **认证**: 管理员权限

#### 删除用户
- **接口**: `DELETE /api/user/admin/users/<int:user_id>`
- **描述**: 删除用户（软删除）
- **认证**: 管理员权限

#### 管理员降级
- **接口**: `POST /api/user/admin/demote/<int:admin_id>`
- **描述**: 将管理员降级为普通用户
- **认证**: 超级管理员权限


#### 创建管理员
- **接口**: `POST /api/user/admin/create-admin`
- **描述**: 创建管理员账号
- **认证**: 超级管理员权限

#### 用户统计
- **接口**: `GET /api/user/admin/statistics`
- **描述**: 获取用户统计信息
- **认证**: 管理员权限

## 2. 管理员模块 (/api/admin)

### 2.1 内容审核 (API_admin/content)

#### 获取待审核内容
- **接口**: `GET /api/admin/content/pending/all`
- **描述**: 获取所有模块待审核内容
- **认证**: 管理员权限

#### 批量审核
- **接口**: `POST /api/admin/content/batch-review`
- **描述**: 批量审核内容
- **认证**: 管理员权限

#### 内容详情
- **接口**: `GET /api/admin/content/detail/<module>/<int:content_id>`
- **描述**: 获取指定模块的内容详情
- **认证**: 管理员权限

#### 导出内容
- **接口**: `POST /api/admin/content/export`
- **描述**: 导出内容数据
- **认证**: 管理员权限

#### 更新用户显示信息
- **接口**: `POST /api/admin/content/update-user-displays`
- **描述**: 批量更新用户显示信息
- **认证**: 超级管理员权限

#### 内容统计
- **接口**: `GET /api/admin/content/statistics`
- **描述**: 获取内容管理统计
- **认证**: 管理员权限

## 3. 公共接口模块 (/api/common)

### 3.1 文件管理

#### 图片上传
- **接口**: `POST /api/common/upload/image`
- **描述**: 上传图片文件
- **认证**: 需要
- **请求**: multipart/form-data

#### 图片删除
- **接口**: `POST /api/common/delete/image`
- **描述**: 删除图片文件
- **认证**: 需要

#### 头像上传
- **接口**: `POST /api/common/upload/avatar`
- **描述**: 专用头像上传接口
- **认证**: 需要

#### 附件管理
- **接口**: `POST /api/common/attachment`
- **描述**: 上传附件文件
- **认证**: 需要

- **接口**: `DELETE /api/common/attachment/<int:attachment_id>`
- **描述**: 删除附件
- **认证**: 需要

- **接口**: `GET /api/common/attachments`
- **描述**: 获取用户附件列表
- **认证**: 需要

- **接口**: `GET /api/common/attachment/<int:attachment_id>`
- **描述**: 获取附件信息
- **认证**: 不需要

### 3.2 科普文章公开接口


#### 新的公开接口
- **接口**: `GET /api/public/science/articles`
- **描述**: 获取科普文章列表（专用公开接口）
- **认证**: 不需要

- **接口**: `GET /api/public/science/articles/<id>`
- **描述**: 获取科普文章详情（专用公开接口）
- **认证**: 不需要

- **接口**: `GET /api/public/science/articles/statistics`
- **描述**: 获取科普文章统计信息
- **认证**: 不需要

### 3.3 活动公开接口


#### 新的公开接口
- **接口**: `GET /api/public/activities/activities`
- **描述**: 获取活动列表（专用公开接口）
- **认证**: 不需要

- **接口**: `GET /api/public/activities/activities/<id>`
- **描述**: 获取活动详情（专用公开接口）
- **认证**: 不需要

- **接口**: `GET /api/public/activities/activities/statistics`
- **描述**: 获取活动统计信息
- **认证**: 不需要

### 3.4 用户操作接口

#### 更新用户信息
- **接口**: `POST /api/common/user/update`
- **描述**: 更新用户基础信息
- **认证**: 需要

#### 获取用户信息
- **接口**: `GET /api/common/user/info`
- **描述**: 获取当前用户信息
- **认证**: 需要

## 4. 论坛模块 (/api/forum)

### 4.1 帖子管理 (API_forum/post)

#### 帖子列表
- **接口**: `GET /api/forum/post`
- **描述**: 获取论坛帖子列表（支持筛选、排序、分页）
- **认证**: 不需要（登录用户有额外功能）

#### 帖子详情
- **接口**: `GET /api/forum/post/<int:post_id>`
- **描述**: 获取帖子详情（增加浏览计数）
- **认证**: 不需要

#### 创建帖子
- **接口**: `POST /api/forum/post`
- **描述**: 创建论坛帖子
- **认证**: 需要

#### 更新帖子
- **接口**: `PUT /api/forum/post/<int:post_id>`
- **描述**: 更新帖子内容
- **认证**: 需要（仅作者和管理员）

#### 删除帖子
- **接口**: `DELETE /api/forum/post/<int:post_id>`
- **描述**: 删除帖子（软删除）
- **认证**: 需要（仅作者和管理员）

#### 热门帖子
- **接口**: `GET /api/forum/post/hot`
- **描述**: 获取热门帖子
- **认证**: 不需要

#### 帖子分类
- **接口**: `GET /api/forum/post/categories`
- **描述**: 获取帖子分类列表
- **认证**: 不需要

#### 帖子搜索
- **接口**: `GET /api/forum/post/search`
- **描述**: 搜索帖子
- **认证**: 不需要

### 4.2 楼层管理 (API_forum/floor)

- **接口**: `GET /api/forum/floor/post/<int:post_id>`
- **描述**: 获取帖子下的楼层列表
- **认证**: 不需要

### 4.3 回复管理 (API_forum/reply)

- **接口**: `GET /api/forum/reply/floor/<int:floor_id>`
- **描述**: 获取楼层下的回复列表
- **认证**: 不需要

- **接口**: `POST /api/forum/reply`
- **描述**: 创建回复
- **认证**: 需要

## 5. 科普模块 (/api/science)

### 5.1 用户科普操作 (/api/science/user)
- **描述**: 用户端的科普文章管理接口
- **状态**: 框架已搭建，具体实现待完善

### 5.2 管理员科普管理 (/api/science/admin)
- **描述**: 管理员端的科普文章管理接口
- **状态**: 框架已搭建，具体实现待完善

### 5.3 科普分类管理 (/api/science/category)
- **描述**: 科普文章分类相关接口
- **状态**: 框架已搭建，具体实现待完善

### 5.4 公开科普接口 (/api/public/science)
- **描述**: 科普文章公开访问接口
- **状态**: 框架已搭建，具体实现待完善

## 6. 活动模块 (/api/activities)

### 6.1 用户活动操作 (/api/activities/user)
- **描述**: 用户活动相关接口
- **状态**: 基础框架已搭建，功能待完善

### 6.2 管理员活动管理 (/api/activities/admin)
- **描述**: 管理员活动管理接口
- **状态**: 基础框架已搭建，功能待完善

### 6.3 活动预约 (/api/activities/booking)
- **描述**: 活动预约系统接口
- **状态**: 数据模型已存在，接口待实现

### 6.4 活动讨论 (/api/activities/discussion)
- **描述**: 活动讨论功能接口
- **状态**: 数据模型已存在，接口待实现

## 7. 公告模块 (/api/notice)

### 7.1 公告管理
- **描述**: 公告CRUD操作接口
- **状态**: 数据模型已存在，基础接口待完善

### 7.2 公告发布
- **描述**: 公告发布和通知功能
- **状态**: 基础框架已搭建，功能待完善

## 8. 公开访问接口详细说明

### 8.1 接口架构特点

所有公开访问接口都遵循以下设计原则：

**🔓 无需认证**: 公开访问，不需要登录即可使用
**📋 统一响应格式**: 使用 `ResponseService` 统一响应格式
**🔧 完整功能**: 支持分页、搜索、筛选等功能
**🔒 安全设计**: 只返回公开信息，不包含敏感数据

### 8.2 模块功能概述

**用户模块** (`/api/public/user/*`):
- 提供用户基础信息查询，不包含敏感数据
- 支持单个和批量查询
- 用户统计分析功能

**内容模块** (`/api/public/science/*`, `/api/public/activities/*`, `/api/public/notice/*`, `/api/public/forum/*`):
- 提供各类内容的公开访问
- 支持关键词搜索、分类筛选、时间范围筛选
- 统计分析功能
- 自动过滤已过期或未发布的内容

### 8.3 详细文档说明

详细的接口参数、响应格式和使用示例请参考以下文档：
- **前端开发接口文档.md** - 完整的API使用说明和权限控制
- **前端调用示例.js** - JavaScript/TypeScript集成示例和类型定义

## 认证和权限控制

### 权限等级

1. **VISIT_PERMISSIONS** - 访客权限
   - 访问公开内容
   - 基础查询功能

2. **USER_PERMISSIONS** - 普通用户权限
   - 包含访客所有权限
   - 发布内容权限
   - 个人信息管理权限

3. **ADMIN_PERMISSIONS** - 管理员权限
   - 包含用户所有权限
   - 用户管理权限
   - 内容审核权限（科普、活动、论坛、公告）
   - 内容导出和统计权限

4. **SUPER_ADMIN_PERMISSIONS** - 超级管理员权限
   - 包含管理员所有权限
   - 管理员管理权限（创建、降级管理员）
   - 系统数据维护权限（更新用户显示信息）
   - 核心管理功能权限
   - 数据库操作权限

### 认证方式

**JWT Token认证:**
- Header: `Authorization: Bearer <token>`
- Token有效期: 可配置
- 支持Token刷新机制

**权限装饰器:**
```python
@token_required              # 基础认证
@user_required              # 用户权限
@admin_required             # 管理员权限
@super_admin_required       # 超级管理员权限
@visit_required             # 访客权限
```

## 系统特性

### 安全机制
- JWT Token认证
- 基于角色的权限控制(RBAC)
- 敏感词过滤
- SQL注入防护
- 软删除机制
- 输入验证和清理

### 性能优化
- 分页查询支持
- 数据库索引优化
- 基础缓存支持
- 异步处理支持

### 数据处理
- 统一的数据格式化
- 灵活的筛选和排序
- 统计分析功能
- 批量操作支持
- 数据导出功能

## 开发状态总结

### ✅ 已完成模块 (100%)
1. **用户管理模块** - 完整的用户CRUD、认证、权限管理
2. **管理员模块** - 完整的管理员权限、内容审核、数据管理
3. **公共接口模块** - 文件上传、内容公开访问、用户操作
4. **论坛模块** - 完整的帖子管理、回复功能
5. **公开接口模块** - 完整的各模块公开访问接口，无需认证即可访问

### ✅ 新增完成模块 (100%)
1. **前端开发接口文档** - ✅ 完整的前端开发指南，包含所有模块接口说明、权限控制、错误码说明、前端集成示例
2. **前端调用示例** - ✅ 完整的JavaScript API调用示例，支持React、Vue等主流框架

### ⚠️ 部分完成模块 (50-80%)
1. **科普模块** - ✅ 接口整合完成，专用公开接口已就绪
2. **活动模块** - ✅ 架构优化完成，专用公开接口已就绪
3. **公告模块** - 数据模型完成，基础功能待完善

### ❌ 待开发模块 (0-30%)
1. **活动预约系统** - 数据模型存在，接口待实现
2. **活动讨论系统** - 数据模型存在，接口待实现
3. **消息通知系统** - 框架缺失
4. **实时聊天功能** - 框架缺失

### 📋 前端开发支持资源
#### 接口完善总结.md
- ✅ 后端项目接口文档总结
- ✅ 技术栈说明和模块化设计
- ✅ 数据模型详解
- ✅ 接口详细说明和使用指南
- ✅ 认证和权限控制系统
- ✅ 开发状态和建议优化方向

#### 前端调用示例.js
- ✅ 使用 /api/public/* 专用公开接口的完整示例
- ✅ 科普文章API服务类 (ScienceArticleService)
- ✅ 活动API服务类 (ActivityService)
- ✅ 完整的TypeScript类型定义
- ✅ React Hook 和 Vue Composable 示例
- ✅ 错误处理和工具函数

#### 前端开发接口文档.md
- ✅ 完整的模块接口文档
- ✅ 权限控制矩阵
- ✅ 错误码说明和解决方案
- ✅ 前端开发注意事项
- ✅ React + TypeScript 集成示例
- ✅ Vue 3 + TypeScript 集成示例
- ✅ 开发最佳实践和技术栈说明
- ✅ 版本更新日志和技术支持

## 建议优化方向

1. **完善未完成模块**：优先完成科普、活动、公告模块的剩余功能
2. **API文档标准化**：集成Swagger或OpenAPI文档
3. **缓存机制**：引入Redis缓存提升性能
4. **日志系统**：完善错误日志记录
5. **监控系统**：添加基础性能监控
6. **测试覆盖**：完善单元测试和集成测试
7. **CI/CD**：建立自动化部署流程

## 最新更新 (2024-12-22)

### 接口架构彻底优化完成
- ✅ **彻底清理common模块** - 移除所有业务接口，保留纯公共功能
- ✅ **建立专用公开接口** - 科普和活动都有独立的公开访问接口
- ✅ **统一架构模式** - `/api/public/*` 标准化公开接口设计
- ✅ **集中业务管理** - 所有业务功能集中在对应专用模块

### 新增活动公开接口
- **模块**: `/api/public/activities/*`
- **功能**: 活动列表、详情、统计查询
- **特点**: 智能状态计算、报名统计、丰富筛选

### 模块职责重新定义
- **common模块**: 仅保留图片上传、用户信息、附件管理等纯公共功能
- **专用模块**: 科普(/api/science/*)、活动(/api/activities/*)等业务功能
- **公开接口**: /api/public/* 标准化设计，无需认证访问

### 接口使用建议
- **新项目**: 直接使用 `/api/public/science/*` 和 `/api/public/activities/*` 专用接口
- **现有项目**: 建议使用 `/api/public/science/*` 和 `/api/public/activities/*` 专用接口
- **业务功能**: 使用对应专用模块的认证接口

## 总结

该后端项目具有清晰的模块化架构和完善的权限控制系统，核心的用户管理、内容管理、论坛功能已经实现并可以投入使用。项目采用Flask + SQLAlchemy技术栈，具有良好的可扩展性和维护性。

最新完成的接口架构彻底优化进一步提升了系统的清晰度和一致性：

**架构优化成果**：
- ✅ **彻底清理common模块** - 移除所有业务接口，保留纯公共功能
- ✅ **统一公开接口设计** - `/api/public/*` 标准化公开访问模式
- ✅ **智能业务功能** - 活动状态计算、报名统计等增强功能
- ✅ **清晰的模块职责** - 每个模块专注自己的业务领域

**主要优势**：
- 完整的用户认证和权限管理体系
- 模块化设计便于扩展和维护
- 统一的接口响应格式和错误处理
- 完善的安全机制和权限控制
- 良好的数据库设计和关联关系
- 智能的活动状态管理和统计功能

需要改进的方面：
- 部分模块功能不完整
- 缺少API文档
- 缺少缓存和性能优化机制
- 测试覆盖率有待提升

整体而言，项目已具备生产环境部署的基础条件，可以支撑前端开发和正常业务运行。